Return-Path: <linux-kernel-owner@vger.kernel.org>
X-Original-To: lists+linux-kernel@lfdr.de
Delivered-To: lists+linux-kernel@lfdr.de
Received: from vger.kernel.org (vger.kernel.org [209.132.180.67])
	by mail.lfdr.de (Postfix) with ESMTP id 468F3101057
	for <lists+linux-kernel@lfdr.de>; Tue, 19 Nov 2019 01:46:16 +0100 (CET)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1727092AbfKSAqN convert rfc822-to-8bit (ORCPT
        <rfc822;lists+linux-kernel@lfdr.de>); Mon, 18 Nov 2019 19:46:13 -0500
Received: from relmlor1.renesas.com ([210.160.252.171]:61506 "EHLO
        relmlie5.idc.renesas.com" rhost-flags-OK-OK-OK-FAIL)
        by vger.kernel.org with ESMTP id S1726809AbfKSAqN (ORCPT
        <rfc822;linux-kernel@vger.kernel.org>);
        Mon, 18 Nov 2019 19:46:13 -0500
Date:   19 Nov 2019 09:46:12 +0900
X-IronPort-AV: E=Sophos;i="5.68,321,1569250800"; 
   d="scan'208";a="32026178"
Received: from unknown (HELO relmlir5.idc.renesas.com) ([10.200.68.151])
  by relmlie5.idc.renesas.com with ESMTP; 19 Nov 2019 09:46:12 +0900
Received: from morimoto-PC.renesas.com (unknown [10.166.18.140])
        by relmlir5.idc.renesas.com (Postfix) with ESMTP id DC54F4001B60;
        Tue, 19 Nov 2019 09:46:11 +0900 (JST)
Message-ID: <8736ek7kx8.wl-kuninori.morimoto.gx@renesas.com>
From:   Kuninori Morimoto <kuninori.morimoto.gx@renesas.com>
To:     Eugeniu Rosca <erosca@de.adit-jv.com>
Cc:     Jiada Wang <jiada_wang@mentor.com>,
        Mark Brown <broonie@kernel.org>, <alsa-devel@alsa-project.org>,
        <linux-kernel@vger.kernel.org>,
        Liam Girdwood <lgirdwood@gmail.com>,
        Jaroslav Kysela <perex@perex.cz>,
        Takashi Iwai <tiwai@suse.com>,
        Eugeniu Rosca <roscaeugeniu@gmail.com>,
        Nilkanth Ahirrao <anilkanth@jp.adit-jv.com>,
        Hiroyuki Yokoyama <hiroyuki.yokoyama.vx@renesas.com>,
        Andrew Gabbasov <andrew_gabbasov@mentor.com>
Subject: Re: [PATCH] ASoC: rsnd: fix DALIGN register for SSIU
In-Reply-To: <20191118140126.23596-1-erosca@de.adit-jv.com>
References: <20191118140126.23596-1-erosca@de.adit-jv.com>
User-Agent: Wanderlust/2.15.9 Emacs/24.5 Mule/6.0
MIME-Version: 1.0 (generated by SEMI-EPG 1.14.7 - "Harue")
Content-Type: text/plain; charset=ISO-8859-7
Content-Transfer-Encoding: 8BIT
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org


Hi Eugeniu

Thank you for your patch.

> From: Nilkanth Ahirrao <anilkanth@jp.adit-jv.com>
> 
> The current driver only sets 0x76543210 and 0x67452301 for DALIGN.
> This doesn¢t work well for TDM split and ex-split mode for all SSIU.
> This patch programs the DALIGN registers based on the SSIU number.
> 
> Cc: Kuninori Morimoto <kuninori.morimoto.gx@renesas.com>
> Cc: Hiroyuki Yokoyama <hiroyuki.yokoyama.vx@renesas.com>
> Cc: Jiada Wang <jiada_wang@mentor.com>
> Cc: Andrew Gabbasov <andrew_gabbasov@mentor.com>
> Fixes: a914e44693d41b ("ASoC: rsnd: more clear rsnd_get_dalign() for DALIGN")
> Signed-off-by: Nilkanth Ahirrao <anilkanth@jp.adit-jv.com>
> [erosca: Adjust Fixes: tag, reformat patch description]
> Signed-off-by: Eugeniu Rosca <erosca@de.adit-jv.com>
> ---
>  sound/soc/sh/rcar/core.c | 25 +++++++++++++++++++++----
>  1 file changed, 21 insertions(+), 4 deletions(-)
> 
> diff --git a/sound/soc/sh/rcar/core.c b/sound/soc/sh/rcar/core.c
> index e9596c2096cd..ae05ed08a2b3 100644
> --- a/sound/soc/sh/rcar/core.c
> +++ b/sound/soc/sh/rcar/core.c
> @@ -376,6 +376,16 @@ u32 rsnd_get_adinr_bit(struct rsnd_mod *mod, struct rsnd_dai_stream *io)
>   */
>  u32 rsnd_get_dalign(struct rsnd_mod *mod, struct rsnd_dai_stream *io)
>  {
> +	static const u32 dalign_values[8][2] = {
> +		{0x76543210, 0x67452301},
> +		{0x00000032, 0x00000023},
> +		{0x00007654, 0x00006745},
> +		{0x00000076, 0x00000067},
> +		{0xfedcba98, 0xefcdab89},
> +		{0x000000ba, 0x000000ab},
> +		{0x0000fedc, 0x0000efcd},
> +		{0x000000fe, 0x000000ef},
> +	};
>  	struct rsnd_mod *ssiu = rsnd_io_to_mod_ssiu(io);
>  	struct rsnd_mod *target;
>  	struct snd_pcm_runtime *runtime = rsnd_io_to_runtime(io);
> @@ -413,11 +423,18 @@ u32 rsnd_get_dalign(struct rsnd_mod *mod, struct rsnd_dai_stream *io)
>  
>  	/* Non target mod or non 16bit needs normal DALIGN */
>  	if ((snd_pcm_format_width(runtime->format) != 16) ||
> -	    (mod != target))
> -		return 0x76543210;
> +	    (mod != target)) {
> +		if (mod == ssiu)
> +			return dalign_values[rsnd_mod_id_sub(mod)][0];
> +		else
> +			return 0x76543210;
>  	/* Target mod needs inverted DALIGN when 16bit */
> -	else
> -		return 0x67452301;
> +	} else {
> +		if (mod == ssiu)
> +			return dalign_values[rsnd_mod_id_sub(mod)][1];
> +		else
> +			return 0x67452301;
> +	}
>  }

Basically I have no objection.
But we can reuse dalign_values[0][x] value ?

	id  = 0;
	if ((snd_pcm_format_width(runtime->format) != 16) ||
	    (mod != target)) {
		inv = 0;
		if (mod == ssiu))
			id = rsnd_mod_id_sub(mod);
	/* Target mod needs inverted DALIGN when 16bit */
	} else {
		inv = 1;
		if (mod == ssiu)
			id = rsnd_mod_id_sub(mod);
	}

	return dalign_values[id][inv];

Thank you for your help !!
Best regards
---
Kuninori Morimoto
