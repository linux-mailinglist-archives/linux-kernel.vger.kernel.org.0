Return-Path: <linux-kernel-owner@vger.kernel.org>
X-Original-To: lists+linux-kernel@lfdr.de
Delivered-To: lists+linux-kernel@lfdr.de
Received: from vger.kernel.org (vger.kernel.org [209.132.180.67])
	by mail.lfdr.de (Postfix) with ESMTP id 692DC6584A
	for <lists+linux-kernel@lfdr.de>; Thu, 11 Jul 2019 15:58:38 +0200 (CEST)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1728668AbfGKN6d (ORCPT <rfc822;lists+linux-kernel@lfdr.de>);
        Thu, 11 Jul 2019 09:58:33 -0400
Received: from mail-yw1-f67.google.com ([209.85.161.67]:37338 "EHLO
        mail-yw1-f67.google.com" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S1728521AbfGKN6c (ORCPT
        <rfc822;linux-kernel@vger.kernel.org>);
        Thu, 11 Jul 2019 09:58:32 -0400
Received: by mail-yw1-f67.google.com with SMTP id u141so3664266ywe.4
        for <linux-kernel@vger.kernel.org>; Thu, 11 Jul 2019 06:58:32 -0700 (PDT)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:mime-version:references:in-reply-to:from:date
         :message-id:subject:to:cc;
        bh=pK5RuemqzmjfGaNsSi/yoU0S3UjJt9iIfzbfFk0y08k=;
        b=XChVgxmF558llg/Wfe2zZ/hRqEUYu5cpcJCQMH1rmimYhFU8GzoZFz3TBxsdQkhqHG
         mnpLyZdNSEXyzYROUptUlpMLkN2QkZYz83SzOM43m6UN3BZlxZLWJ9gJfgbyN9IUOSXm
         +PibDc0mEMkBKWl9d0mb+rBfLz1SSo0elXFk/c7uBYg3R+CTwEHMJYPjpv8fP9wEJFxM
         AwSP40DIMFFxRRM95VbClM0J+0D2JP2mpl9Q5yy7wwV45lZxdkvq76kXjV5csrDGM4U3
         slu1HWCXOEbt32aOhAZXV+gMEB5lsW6kA9l91JwlmxLeBVkAUpXsqTWnBFRpX6BNzccO
         YXCg==
X-Gm-Message-State: APjAAAUUB2HUQh10YGodzY840pJ70r76JnPzIYYgVJd5/7t/R9bX7e5w
        14WndE50Tm874CRuVqlnS8zqnFl+sfWUnnv5eBo=
X-Google-Smtp-Source: APXvYqxlRGrzT0WRQWAIaJ6PXTGpdiBhJc0q7MhnNHYLJ1o9bmWgU+GnNql43L0osZU4GcZNqRsc7OKqiFIqkI61T2E=
X-Received: by 2002:aed:3e7c:: with SMTP id m57mr2188016qtf.204.1562853511993;
 Thu, 11 Jul 2019 06:58:31 -0700 (PDT)
MIME-Version: 1.0
References: <20190711132757.130092-1-wangkefeng.wang@huawei.com>
In-Reply-To: <20190711132757.130092-1-wangkefeng.wang@huawei.com>
From:   Arnd Bergmann <arnd@arndb.de>
Date:   Thu, 11 Jul 2019 15:58:11 +0200
Message-ID: <CAK8P3a28tzX1u2mMNt1j1478n3oAkJ=ihtBw=dJ+r-xdteSZ8w@mail.gmail.com>
Subject: Re: [PATCH v2] hpet: Fix division by zero in hpet_time_div()
To:     Kefeng Wang <wangkefeng.wang@huawei.com>
Cc:     Clemens Ladisch <clemens@ladisch.de>,
        Greg Kroah-Hartman <gregkh@linuxfoundation.org>,
        Linux Kernel Mailing List <linux-kernel@vger.kernel.org>
Content-Type: text/plain; charset="UTF-8"
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

On Thu, Jul 11, 2019 at 3:22 PM Kefeng Wang <wangkefeng.wang@huawei.com> wrote:
>
> The base value in do_div() called by hpet_time_div() is truncated from
> unsigned long to uint32_t, resulting in a divide-by-zero exception.
>
> UBSAN: Undefined behaviour in ../drivers/char/hpet.c:572:2
> division by zero
> CPU: 1 PID: 23682 Comm: syz-executor.3 Not tainted 4.4.184.x86_64+ #4
> Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS Ubuntu-1.8.2-1ubuntu1 04/01/2014
>  0000000000000000 b573382df1853d00 ffff8800a3287b98 ffffffff81ad7561
>  ffff8800a3287c00 ffffffff838b35b0 ffffffff838b3860 ffff8800a3287c20
>  0000000000000000 ffff8800a3287bb0 ffffffff81b8f25e ffffffff838b35a0
> Call Trace:
>  [<ffffffff81ad7561>] __dump_stack lib/dump_stack.c:15 [inline]
>  [<ffffffff81ad7561>] dump_stack+0xc1/0x120 lib/dump_stack.c:51
>  [<ffffffff81b8f25e>] ubsan_epilogue+0x12/0x8d lib/ubsan.c:166
>  [<ffffffff81b900cb>] __ubsan_handle_divrem_overflow+0x282/0x2c8 lib/ubsan.c:262
>  [<ffffffff823560dd>] hpet_time_div drivers/char/hpet.c:572 [inline]
>  [<ffffffff823560dd>] hpet_ioctl_common drivers/char/hpet.c:663 [inline]
>  [<ffffffff823560dd>] hpet_ioctl_common.cold+0xa8/0xad drivers/char/hpet.c:577
>  [<ffffffff81e63d56>] hpet_ioctl+0xc6/0x180 drivers/char/hpet.c:676
>  [<ffffffff81711590>] vfs_ioctl fs/ioctl.c:43 [inline]
>  [<ffffffff81711590>] file_ioctl fs/ioctl.c:470 [inline]
>  [<ffffffff81711590>] do_vfs_ioctl+0x6e0/0xf70 fs/ioctl.c:605
>  [<ffffffff81711eb4>] SYSC_ioctl fs/ioctl.c:622 [inline]
>  [<ffffffff81711eb4>] SyS_ioctl+0x94/0xc0 fs/ioctl.c:613
>  [<ffffffff82846003>] tracesys_phase2+0x90/0x95
>
> The main C reproducer autogenerated by syzkaller,
>
>   syscall(__NR_mmap, 0x20000000, 0x1000000, 3, 0x32, -1, 0);
>   memcpy((void*)0x20000100, "/dev/hpet\000", 10);
>   syscall(__NR_openat, 0xffffffffffffff9c, 0x20000100, 0, 0);
>   syscall(__NR_ioctl, r[0], 0x40086806, 0x40000000000000);
>
> Fix it by using div64_ul().
>
> Signed-off-by: Kefeng Wang <wangkefeng.wang@huawei.com>
> Signed-off-by: Zhang HongJun <zhanghongjun2@huawei.com>

Reviewed-by: Arnd Bergmann <arnd@arndb.de>
