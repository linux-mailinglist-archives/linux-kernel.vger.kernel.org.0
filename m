Return-Path: <linux-kernel-owner@vger.kernel.org>
X-Original-To: lists+linux-kernel@lfdr.de
Delivered-To: lists+linux-kernel@lfdr.de
Received: from vger.kernel.org (vger.kernel.org [209.132.180.67])
	by mail.lfdr.de (Postfix) with ESMTP id BD7C319DC3
	for <lists+linux-kernel@lfdr.de>; Fri, 10 May 2019 15:04:25 +0200 (CEST)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1727562AbfEJNEW (ORCPT <rfc822;lists+linux-kernel@lfdr.de>);
        Fri, 10 May 2019 09:04:22 -0400
Received: from mx2.suse.de ([195.135.220.15]:40706 "EHLO mx1.suse.de"
        rhost-flags-OK-OK-OK-FAIL) by vger.kernel.org with ESMTP
        id S1727333AbfEJNEV (ORCPT <rfc822;linux-kernel@vger.kernel.org>);
        Fri, 10 May 2019 09:04:21 -0400
X-Virus-Scanned: by amavisd-new at test-mx.suse.de
Received: from relay2.suse.de (unknown [195.135.220.254])
        by mx1.suse.de (Postfix) with ESMTP id 770F3AD69;
        Fri, 10 May 2019 13:04:20 +0000 (UTC)
Date:   Fri, 10 May 2019 15:04:19 +0200
Message-ID: <s5hlfzempf0.wl-tiwai@suse.de>
From:   Takashi Iwai <tiwai@suse.de>
To:     Pierre-Louis Bossart <pierre-louis.bossart@linux.intel.com>
Cc:     YueHaibing <yuehaibing@huawei.com>, lgirdwood@gmail.com,
        rdunlap@infradead.org, broonie@kernel.org, perex@perex.cz,
        alsa-devel@alsa-project.org, linux-kernel@vger.kernel.org
Subject: Re: [PATCH] ASoC: SOF: Fix build error with CONFIG_SND_SOC_SOF_NOCODEC=m
In-Reply-To: <73c6dd27-895a-adba-a4ef-2992266fcc48@linux.intel.com>
References: <20190510023657.8960-1-yuehaibing@huawei.com>
        <s5h7eayn5or.wl-tiwai@suse.de>
        <73c6dd27-895a-adba-a4ef-2992266fcc48@linux.intel.com>
User-Agent: Wanderlust/2.15.9 (Almost Unreal) SEMI/1.14.6 (Maruoka)
 FLIM/1.14.9 (=?UTF-8?B?R29qxY0=?=) APEL/10.8 Emacs/25.3
 (x86_64-suse-linux-gnu) MULE/6.0 (HANACHIRUSATO)
MIME-Version: 1.0 (generated by SEMI 1.14.6 - "Maruoka")
Content-Type: text/plain; charset=US-ASCII
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

On Fri, 10 May 2019 14:56:29 +0200,
Pierre-Louis Bossart wrote:
> 
> On 5/10/19 2:12 AM, Takashi Iwai wrote:
> > On Fri, 10 May 2019 04:36:57 +0200,
> > YueHaibing wrote:
> >>
> >> Fix gcc build error while CONFIG_SND_SOC_SOF_NOCODEC=m
> >>
> >> sound/soc/sof/core.o: In function `snd_sof_device_probe':
> >> core.c:(.text+0x4af): undefined reference to `sof_nocodec_setup'
> >>
> >> Change SND_SOC_SOF_NOCODEC to bool to fix this.
> >>
> >> Reported-by: Hulk Robot <hulkci@huawei.com>
> >> Fixes: c16211d6226d ("ASoC: SOF: Add Sound Open Firmware driver core")
> >> Signed-off-by: YueHaibing <yuehaibing@huawei.com>
> >
> > This change would break things severely.  This won't allow to build it
> > as a module any longer.
> 
> Isn't this fixed already?
> See the patch  'ASoC: SOF: core: fix undefined nocodec reference' and
> Takashi's follow-up to fix the unused variable warning.

Possibly the problem still persists although I haven't seen through my
local build tests with randconfig.  You can set SND_SOC_SOF=y and
SND_SOC_NOCODEC=m, i.e. built-in sof-core while nocodec is a module.


Takashi

> >
> > A better fix would be to somehow restrict the SND_SOC_SOF_NOCODEC to
> > align with SND_SOC_SOF, i.e. disallow SND_SOC_SOF=y &&
> > SND_SOC_SOF_NOCODEC=m.  Because of the complex mix of select and
> > depends-on in SOF, I'm afraid that it's not that trivial, though.
> > There might be something I overlooked, hopefully...
> >
> > An easier alternative would be to replace
> > IS_ENABLED(CONFIG_SND_SOC_SOF_NOCODEC) with
> > IS_REACHABLE(CONFIG_SND_SOC_SOF_NOCODEC).  This assures the condition
> > at the build time, although the error at probe might be a surprising
> > to some users that don't know this hidden dependency.
> >
> >
> > thanks,
> >
> > Takashi
> >
> >
> >> ---
> >>   sound/soc/sof/Kconfig | 2 +-
> >>   1 file changed, 1 insertion(+), 1 deletion(-)
> >>
> >> diff --git a/sound/soc/sof/Kconfig b/sound/soc/sof/Kconfig
> >> index b204c65..9c280c9 100644
> >> --- a/sound/soc/sof/Kconfig
> >> +++ b/sound/soc/sof/Kconfig
> >> @@ -44,7 +44,7 @@ config SND_SOC_SOF_OPTIONS
> >>   if SND_SOC_SOF_OPTIONS
> >>     config SND_SOC_SOF_NOCODEC
> >> -	tristate "SOF nocodec mode Support"
> >> +	bool "SOF nocodec mode Support"
> >>   	help
> >>   	  This adds support for a dummy/nocodec machine driver fallback
> >>   	  option if no known codec is detected. This is typically only
> >> -- 
> >> 2.7.4
> >>
> >>
> >>
> 
